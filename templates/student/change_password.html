{% extends "base.html" %}

{% block title %}Change Password{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">Student Portal</h2>
        </div>
        <ul class="sidebar-nav">
            <li><a href="{{ url_for('student.dashboard') }}">Dashboard</a></li>
            <li><a href="{{ url_for('student.pay_fees') }}">Pay Fees</a></li>
            <li><a href="{{ url_for('student.transaction_history') }}">Transaction History</a></li>
            <li><a href="{{ url_for('student.change_password') }}" class="active">Change Password</a></li>
        </ul>
    </aside>
    
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Change Password</h1>
        </div>
        
        <div class="card" style="max-width: 600px;">
            <h3 class="card-header">Update Your Password</h3>
            
            <div style="background-color: #d1f4ff; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem; border-left: 4px solid #0ea5e9;">
                <h4 style="color: #0c4a6e; margin-bottom: 0.5rem;">ðŸ“± OTP Verification Required</h4>
                <p style="color: #0c4a6e; margin: 0.25rem 0;">For security, we'll send an OTP to your registered:</p>
                <ul style="color: #0c4a6e; margin-left: 1.5rem;">
                    <li>Phone Number: <strong>{{ student.phone }}</strong></li>
                    <li>Email: <strong>{{ student.email }}</strong></li>
                </ul>
            </div>
            
            <div id="step1" style="display: block;">
                <h4>Step 1: Request OTP</h4>
                <div class="form-group">
                    <label class="form-label">Select OTP Delivery Method</label>
                    <select id="otp_method" class="form-control" required>
                        <option value="">-- Select Method --</option>
                        <option value="phone">Send OTP to Phone ({{ student.phone }})</option>
                        <option value="email">Send OTP to Email ({{ student.email }})</option>
                    </select>
                </div>
                <button type="button" onclick="sendOTP()" class="btn btn-primary" id="sendOTPBtn">Send OTP</button>
                <div id="otpSentMessage" style="display: none; margin-top: 1rem; padding: 0.75rem; background-color: #d1fae5; color: #065f46; border-radius: 0.375rem;">
                    âœ“ OTP sent successfully! Please check your phone/email.
                </div>
            </div>
            
            <form id="changePasswordForm" style="display: none;">
                <h4>Step 2: Verify OTP and Change Password</h4>
                
                <div class="form-group">
                    <label class="form-label">Enter OTP</label>
                    <input type="text" id="otp_code" class="form-control" required 
                           placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}">
                    <small style="color: var(--text-secondary);">Enter the 6-digit OTP sent to your phone/email</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" id="current_password" class="form-control" required 
                           placeholder="Enter your current password">
                    <small style="color: var(--text-secondary);">Your current password is your phone number</small>
                </div>
                
                <hr style="margin: 1.5rem 0;">
                
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" id="new_password" class="form-control" required 
                           minlength="6" placeholder="Enter new password">
                    <small style="color: var(--text-secondary);">Minimum 6 characters</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" id="confirm_password" class="form-control" required 
                           minlength="6" placeholder="Re-enter new password">
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Change Password</button>
                    <a href="{{ url_for('student.dashboard') }}" class="btn btn-secondary" style="flex: 1; text-align: center;">Cancel</a>
                </div>
            </form>
        </div>
        
        <div class="card" style="max-width: 600px;">
            <h3 class="card-header">Password Security Tips</h3>
            <ul style="margin-left: 1.5rem;">
                <li>Use a strong password with letters, numbers, and symbols</li>
                <li>Don't use the same password for multiple accounts</li>
                <li>Don't share your password with anyone</li>
                <li>Change your password regularly</li>
                <li>Keep your registered phone number and email secure</li>
                <li>Never share your OTP with anyone</li>
            </ul>
        </div>
    </main>
</div>

<script>
let otpSessionId = null;

function sendOTP() {
    const method = document.getElementById('otp_method').value;
    
    if (!method) {
        alert('Please select OTP delivery method');
        return;
    }
    
    const sendBtn = document.getElementById('sendOTPBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending OTP...';
    
    fetch('/student/send-otp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ method: method })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            otpSessionId = data.session_id;
            document.getElementById('otpSentMessage').style.display = 'block';
            document.getElementById('changePasswordForm').style.display = 'block';
            document.getElementById('step1').style.display = 'none';
        } else {
            alert('Error sending OTP: ' + data.message);
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send OTP';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending OTP');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send OTP';
    });
}

document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const otpCode = document.getElementById('otp_code').value;
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('Password must be at least 6 characters');
        return;
    }
    
    fetch('/student/verify-otp-change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: otpSessionId,
            otp_code: otpCode,
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Password changed successfully!');
            window.location.href = "{{ url_for('student.dashboard') }}";
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error changing password');
    });
});
</script>
{% endblock %}